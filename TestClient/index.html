<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>WebSocket Test Client</title>


</head>
<body>
<script>
    function log(value) {
        console.log(value)
    }

    class socketHelper {
        constructor(from, to, event, data) {
            this.sendData = {}
            this.sendData.from = from
            this.sendData.to = to
            this.sendData.event = event
            this.sendData.data = data
        }

        getSendData() {
            return JSON.stringify(this.sendData)
        }
    }

    // https://developer.mozilla.org/zh-CN/docs/Web/API/WebSockets_API/Writing_WebSocket_client_applications
    var ws = new WebSocket("ws://127.0.0.1:8282")

    // 向服务器发送数据
    // ws.send("Here's some text that the server is urgently awaiting!");

    // webSocket链接时触发, 只发送一次
    ws.onopen = function (event) {
        log('onopen:')

        // log(event);

        // 构造发送的数据, socket 一般只做转发
        sh = new socketHelper(
            "live1",
            "class1",
            "onopen",
            {
                age: 29,
                name: "linxl",
                student_ids: [1, 2, 3]
            }
        )

        ws.send(sh.getSendData());

        // 特殊事件名约定, socket 服务器把当前客户加入指定 group
        sh = new socketHelper(
            "live1",
            "",
            "join_group",
            [
                "live1",
                "teacher1"
            ]
        );

        ws.send(sh.getSendData());
    }

    ws.onmessage = function (event) {
        log('onmessage:')
    }

    ws.onclose = function (event) {
        log('onclose:')
    }

    ws.onerror = function() {
        log('onerror:')
    }

    /*
        // 使用 JSON 发送对象
        // 服务器向所有用户发送文本
        function sendText() {
            // 构造一个 msg 对象， 包含了服务器处理所需的数据
            var msg = {
                type: "message",
                text: document.getElementById("text").value,
                id:   clientID,
                date: Date.now()
            };

            // 把 msg 对象作为JSON格式字符串发送
            ws.send(JSON.stringify(msg));

            // 清空文本输入元素，为接收下一条消息做好准备。
            document.getElementById("text").value = "";
        }

        // 接收服务器发送的消息
        ws.onmessage = function (event) {
            console.log(event.data);
        }

        // 接受与解析 JSON 对象
        ws.onmessage = function(event) {
            var f = document.getElementById("chatbox").contentDocument;
            var text = "";
            var msg = JSON.parse(event.data);
            var time = new Date(msg.date);
            var timeStr = time.toLocaleTimeString();

            switch(msg.type) {
                case "id":
                    clientID = msg.id;
                    setUsername();
                    break;
                case "username":
                    text = "<b>User <em>" + msg.name + "</em> signed in at " + timeStr + "</b><br>";
                    break;
                case "message":
                    text = "(" + timeStr + ") <b>" + msg.name + "</b>: " + msg.text + "<br>";
                    break;
                case "rejectusername":
                    text = "<b>Your username has been set to <em>" + msg.name + "</em> because the name you chose is in use.</b><br>"
                    break;
                case "userlist":
                    var ul = "";
                    for (i=0; i < msg.users.length; i++) {
                        ul += msg.users[i] + "<br>";
                    }
                    document.getElementById("userlistbox").innerHTML = ul;
                    break;
            }

            if (text.length) {
                f.write(text);
                document.getElementById("chatbox").contentWindow.scrollByPages(1);
            }
        };
    */
    // 关闭链接
    // ws.close();
</script>
</body>
</html>